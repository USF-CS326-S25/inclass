# Read System Call Flow from User to Console Driver

```mermaid
sequenceDiagram
    participant User as User Program
    participant Usys as usys.S (syscall stub)
    participant Trap as trap.c (usertrap)
    participant Syscall as syscall.c
    participant Sysfile as sysfile.c (sys_read)
    participant File as file.c (fileread)
    participant Console as console.c (consoleread)
    participant Uart as uart.c
    participant Hardware as UART Hardware

    User->>Usys: read(0, buf, n)
    Note over Usys: Load SYS_read (5) into a7
    Note over Usys: Execute ecall instruction
    
    Usys->>Trap: trap to kernel (ecall)
    Note over Trap: Detect system call (scause = 8)
    
    Trap->>Syscall: syscall()
    Note over Syscall: Use a7 to find syscall function
    
    Syscall->>Sysfile: sys_read()
    Note over Sysfile: Extract fd=0, buffer, size args
    Note over Sysfile: Get file struct for fd 0
    
    Sysfile->>File: fileread(f, addr, n)
    Note over File: Check if file is readable
    Note over File: For device file (CONSOLE), call device read
    
    File->>Console: consoleread(user_dst, dst, n)
    Note over Console: Acquire console lock
    
    loop Until buffer has data or EOF
        Console-->>Console: Wait for input (sleep)
        Note over Console: Process is sleeping until input arrives
        
        Hardware->>Uart: UART Interrupt
        Note over Uart: Hardware signals data available
        
        Uart->>Uart: uartintr()
        Note over Uart: Read character from UART register
        
        Uart->>Console: consoleintr(c)
        Note over Console: Add character to console buffer
        Note over Console: If newline or buffer full, wake up reader
        
        Console-->>Console: Wake up from sleep
    end
    
    Console->>User: Copy data to user buffer
    Note over Console: Release console lock
    
    Console-->>File: Return bytes read
    File-->>Sysfile: Return bytes read
    Sysfile-->>Syscall: Return bytes read
    Syscall-->>Trap: Store result in a0
    Trap-->>Usys: Return to user mode
    Usys-->>User: Return bytes read
```

## Key Components

1. **User Program**: Calls `read(0, buf, n)` to read from stdin
2. **System Call Stub**: Generated by usys.pl, sets up registers and executes `ecall`
3. **Trap Handler**: Handles the trap, identifies it as a system call
4. **System Call Dispatcher**: Uses syscall number to call the right function
5. **sys_read**: Extracts arguments and gets the file struct
6. **fileread**: Handles different file types, calls device read for console
7. **consoleread**: Waits for and processes console input
8. **UART Interrupt Handler**: Reads from hardware and feeds to console
9. **Console Buffer**: Stores characters until a full line is ready

## Special Notes

- The process sleeps in `consoleread` until input is available
- Input arrives via interrupts that call `uartintr` â†’ `consoleintr`
- Console input is buffered until a newline or the buffer is full
- File descriptor 0 is set up during process initialization to point to the console device