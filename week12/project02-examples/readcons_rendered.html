<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Read System Call Flow from User to Console Driver</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        h1, h2 {
            color: #2c3e50;
        }
        pre {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        code {
            font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
        }
        .mermaid {
            text-align: center;
            margin: 30px 0;
        }
        ol {
            padding-left: 20px;
        }
        li {
            margin-bottom: 8px;
        }
    </style>
    <!-- Include Mermaid -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
</head>
<body>
    <div id="content">
        <h1>Read System Call Flow from User to Console Driver</h1>
        
        <div class="mermaid">
sequenceDiagram
    participant User as User Program
    participant Usys as usys.S (syscall stub)
    participant Trap as trap.c (usertrap)
    participant Syscall as syscall.c
    participant Sysfile as sysfile.c (sys_read)
    participant File as file.c (fileread)
    participant Console as console.c (consoleread)
    participant Uart as uart.c
    participant Hardware as UART Hardware

    User->>Usys: read(0, buf, n)
    Note over Usys: Load SYS_read (5) into a7
    Note over Usys: Execute ecall instruction
    
    Usys->>Trap: trap to kernel (ecall)
    Note over Trap: Detect system call (scause = 8)
    
    Trap->>Syscall: syscall()
    Note over Syscall: Use a7 to find syscall function
    
    Syscall->>Sysfile: sys_read()
    Note over Sysfile: Extract fd=0, buffer, size args
    Note over Sysfile: Get file struct for fd 0
    
    Sysfile->>File: fileread(f, addr, n)
    Note over File: Check if file is readable
    Note over File: For device file (CONSOLE), call device read
    
    File->>Console: consoleread(user_dst, dst, n)
    Note over Console: Acquire console lock
    
    loop Until buffer has data or EOF
        Console-->>Console: Wait for input (sleep)
        Note over Console: Process is sleeping until input arrives
        
        Hardware->>Uart: UART Interrupt
        Note over Uart: Hardware signals data available
        
        Uart->>Uart: uartintr()
        Note over Uart: Read character from UART register
        
        Uart->>Console: consoleintr(c)
        Note over Console: Add character to console buffer
        Note over Console: If newline or buffer full, wake up reader
        
        Console-->>Console: Wake up from sleep
    end
    
    Console->>User: Copy data to user buffer
    Note over Console: Release console lock
    
    Console-->>File: Return bytes read
    File-->>Sysfile: Return bytes read
    Sysfile-->>Syscall: Return bytes read
    Syscall-->>Trap: Store result in a0
    Trap-->>Usys: Return to user mode
    Usys-->>User: Return bytes read
        </div>
        
        <h2>Key Components</h2>
        
        <ol>
            <li><strong>User Program</strong>: Calls <code>read(0, buf, n)</code> to read from stdin</li>
            <li><strong>System Call Stub</strong>: Generated by usys.pl, sets up registers and executes <code>ecall</code></li>
            <li><strong>Trap Handler</strong>: Handles the trap, identifies it as a system call</li>
            <li><strong>System Call Dispatcher</strong>: Uses syscall number to call the right function</li>
            <li><strong>sys_read</strong>: Extracts arguments and gets the file struct</li>
            <li><strong>fileread</strong>: Handles different file types, calls device read for console</li>
            <li><strong>consoleread</strong>: Waits for and processes console input</li>
            <li><strong>UART Interrupt Handler</strong>: Reads from hardware and feeds to console</li>
            <li><strong>Console Buffer</strong>: Stores characters until a full line is ready</li>
        </ol>
        
        <h2>Special Notes</h2>
        
        <ul>
            <li>The process sleeps in <code>consoleread</code> until input is available</li>
            <li>Input arrives via interrupts that call <code>uartintr</code> â†’ <code>consoleintr</code></li>
            <li>Console input is buffered until a newline or the buffer is full</li>
            <li>File descriptor 0 is set up during process initialization to point to the console device</li>
        </ul>
    </div>

    <script>
        // Initialize Mermaid
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose',
            flowchart: { 
                useMaxWidth: false,
                htmlLabels: true
            }
        });
    </script>
</body>
</html>